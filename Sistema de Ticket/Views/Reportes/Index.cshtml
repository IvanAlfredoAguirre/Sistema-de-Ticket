@model Sistema_de_Ticket.ViewModels.ReportesVM
@using System.Text.Json

@{
    ViewData["Title"] = "Reportes";

    // permiso enviado desde el controlador
    bool puedeExportar = ViewBag.PuedeExportar ?? false;

    var pieData = new[] { Model.EnCurso, Model.Resueltos, Model.SinAsignar };
    var pieLabels = new[] { "En curso", "Resueltos", "Sin asignar" };

    var lineaLabels = Model.SeriePorFecha
        .OrderBy(p => p.Fecha)
        .Select(p => p.Fecha.ToString("dd/MM"))
        .ToArray();

    var lineaValues = Model.SeriePorFecha
        .OrderBy(p => p.Fecha)
        .Select(p => p.Cantidad)
        .ToArray();
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Reportes</h2>

    @if (puedeExportar)
    {
        <button class="btn btn-outline-secondary" onclick="exportarPdf()">
            Exportar a PDF
        </button>
    }
</div>

<div id="reportContainer">

    <!-- ======================= GRAFICO DE PIE ======================= -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4 col-md-5">
            <div class="card-help p-3 h-100">
                <h5 class="mb-3">Estados de tickets</h5>
                <canvas id="chartPie"></canvas>
            </div>
        </div>

        <!-- ======================= GRAFICO DE LINEA ======================= -->
        <div class="col-lg-8 col-md-7">
            <div class="card-help p-3 h-100">
                <h5 class="mb-3">Tickets por fecha</h5>
                <canvas id="chartLinea"></canvas>
            </div>
        </div>
    </div>

    <!-- ======================= FILTROS ======================= -->
    <div class="card-help p-3 mb-3">

        <form method="get" class="row g-2 align-items-end">

            <div class="col-12 col-md-3">
                <label class="form-label">Usuario creador</label>
                <select name="usuarioId" class="form-select">
                    <option value="">-- Todos --</option>
                    @foreach (var u in Model.Usuarios)
                    {
                        <option value="@u.Value" selected="@(u.Selected ? "selected" : null)">
                            @u.Text
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label">Técnico asignado</label>
                <select name="tecnicoId" class="form-select">
                    <option value="">-- Todos --</option>
                    @foreach (var t in Model.Tecnicos)
                    {
                        <option value="@t.Value" selected="@(t.Selected ? "selected" : null)">
                            @t.Text
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Severidad</label>
                <select name="severidad" class="form-select">
                    <option value="">-- Todas --</option>
                    @foreach (var s in Model.Severidades)
                    {
                        <option value="@s.Value" selected="@(s.Selected ? "selected" : null)">
                            @s.Text
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Desde</label>
                <input type="date" class="form-control" name="desde"
                       value="@(Model.Desde?.ToString("yyyy-MM-dd"))">
            </div>

            <div class="col-12 col-md-2">
                <label class="form-label">Hasta</label>
                <input type="date" class="form-control" name="hasta"
                       value="@(Model.Hasta?.ToString("yyyy-MM-dd"))">
            </div>

            <div class="col-12 mt-2 d-flex gap-2">
                <button class="btn btn-primary" type="submit">Aplicar filtros</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Limpiar</a>
            </div>

        </form>
    </div>

    <!-- ======================= TABLA ======================= -->
    <div class="card-help p-0">
        <div class="p-3 border-bottom fw-semibold">
            Tickets (según filtros)
        </div>

        <div class="table-responsive">
            <table class="table mb-0 align-middle">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Severidad</th>
                        <th>Usuario</th>
                        <th>Técnico</th>
                        <th>Fecha creación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in Model.Tickets)
                    {
                        <tr>
                            <td>@t.Titulo</td>
                            <td>@t.Estado</td>
                            <td>@t.Severidad</td>
                            <td>@t.Usuario</td>
                            <td>@t.Tecnico</td>
                            <td>@t.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                        </tr>
                    }

                    @if (!Model.Tickets.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">
                                No hay datos para los filtros seleccionados.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script src="~/lib/jspdf/jspdf.umd.min.js"></script>

    <script>
        const puedeExportar = @puedeExportar.ToString().ToLower();

        /* ========== GRAFICO PIE ========== */
        new Chart(document.getElementById("chartPie"), {
            type: 'pie',
            data: {
                labels: @Html.Raw(JsonSerializer.Serialize(pieLabels)),
                datasets: [{ data: @Html.Raw(JsonSerializer.Serialize(pieData)) }]
            }
        });

        /* ========== GRAFICO LINEA ========== */
        new Chart(document.getElementById("chartLinea"), {
            type: 'line',
            data: {
                labels: @Html.Raw(JsonSerializer.Serialize(lineaLabels)),
                datasets: [{
                    label: "Tickets",
                    data: @Html.Raw(JsonSerializer.Serialize(lineaValues)),
                    fill: false,
                    tension: 0.2
                }]
            }
        });

        /* ========== EXPORTAR PDF ========== */
        function exportarPdf() {

            if (!puedeExportar) {
                alert("No tienes permiso para exportar reportes.");
                return;
            }

            const { jsPDF } = window.jspdf;

            html2canvas(document.getElementById("reportContainer")).then(canvas => {
                const img = canvas.toDataURL("image/png");
                const pdf = new jsPDF('l', 'mm', 'a4');
                pdf.addImage(img, 'PNG', 5, 5, 287, 200);
                pdf.save("reporte-tickets.pdf");
            });
        }
    </script>
}
